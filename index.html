<!DOCTYPE html>
<!--HTML 5-->

<html lang="en">

  <head>

    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-signin-client_id" content="671722528125-i7tojhm11u449jnsjhvut7esm6q4c01m.apps.googleusercontent.com">

    
      
      <!-- Font Awesome -->
    <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    rel="stylesheet"
    />
    <!-- Google Fonts -->
    <link
    href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
    rel="stylesheet"
    />
    <!-- MDB -->
    <link
    href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.6.0/mdb.min.css"
    rel="stylesheet"
    />
      
  <!-- <link rel="stylesheet" href="bootstrap.min.css"> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
  
  
   
    <link rel = "stylesheet" href="style.css">  
 
    <title>GMAIL-CLONE</title>

    <style>
     

    </style>
  </head>

  <body >
      
<!-- 
    <div class="g-signin2" data-onsuccess="onSignIn"></div> -->

    
    <!--Add buttons to initiate auth sequence and sign out-->
    <!-- <button id="authorize_button" style="display: none;">Authorize</button>
    <button id="signout_button" style="display: none;">Sign Out</button>

    <pre id="content" style="white-space: pre-wrap;"></pre> -->



<!-- 
    <div class="g-signin2 sign-in" data-onsuccess="onSignIn"></div>
    <button class="sign-out" onclick="signOut()">Sign-out</button> -->







    <button id="sign-in-or-out-button">Sign In/Authorize</button>
<button id="revoke-access-button">Revoke access</button>

<div id="auth-status" style="display: inline; padding-left: 25px"></div>
<hr>

<div></div>


<div>
    <button>3lines</button>
    <button class="compose-btn">Compose</button>
    <div class="menu">
        <ul>
            <li><button>ALL</button></li>
            <li><button>INBOX</button></li>
            <li><button>SENT</button></li>
            <li><button>DRAFT</button></li>
        </ul>
    </div>
</div>

    

<div class="mails">

</div>







 <script>
     console.log("script");
     



let sentmsgs;
let primarymsgs;
var sentmails=[];
// var primarymails=[];

let content =document.querySelector(".mails");

var GoogleAuth;
  var SCOPE = 'https://mail.google.com/';
  function handleClientLoad() {
    // Load the API's client and auth2 modules.
    // Call the initClient function after the modules load.
    gapi.load('client:auth2', initClient);
  }

  function initClient() {
    // In practice, your app can retrieve one or more discovery documents.
    var discoveryUrl = "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest";

    // Initialize the gapi.client object, which app uses to make API requests.
    // Get API key and client ID from API Console.
    // 'scope' field specifies space-delimited list of access scopes.
    gapi.client.init({
        'apiKey': 'AIzaSyD3e759aqpXnuiQzAMwAJGrPhKLI0JZDUI',
        'clientId': '671722528125-i7tojhm11u449jnsjhvut7esm6q4c01m.apps.googleusercontent.com',
        'discoveryDocs': [discoveryUrl],
        'scope': SCOPE
    }).then(function () {
      GoogleAuth = gapi.auth2.getAuthInstance();

      // Listen for sign-in state changes.
      GoogleAuth.isSignedIn.listen(updateSigninStatus);

      // Handle initial sign-in state. (Determine if user is already signed in.)
      var user = GoogleAuth.currentUser.get();
      setSigninStatus();
      getData();

      // Call handleAuthClick function when user clicks on
      //      "Sign In/Authorize" button.
      $('#sign-in-or-out-button').click(function() {
        handleAuthClick();
      });
      $('#revoke-access-button').click(function() {
        revokeAccess();
      });
    });
  }

  function handleAuthClick() {
    if (GoogleAuth.isSignedIn.get()) {
      // User is authorized and has clicked "Sign out" button.
      GoogleAuth.signOut();
    } else {
      // User is not signed in. Start Google auth flow.
      GoogleAuth.signIn();
    }
  }

  function revokeAccess() {
    GoogleAuth.disconnect();
  }

  function setSigninStatus() {
    var user = GoogleAuth.currentUser.get();
    var isAuthorized = user.hasGrantedScopes(SCOPE);
    if (isAuthorized) {
      $('#sign-in-or-out-button').html('Sign out');
      $('#revoke-access-button').css('display', 'inline-block');
      $('#auth-status').html('You are currently signed in and have granted ' +
          'access to this app.');
          
 
    } else {
      $('#sign-in-or-out-button').html('Sign In/Authorize');
      $('#revoke-access-button').css('display', 'none');
      $('#auth-status').html('You have not authorized this app or you are ' +
          'signed out.');
    }
  }

  function updateSigninStatus() {
    setSigninStatus();
  }

function getData(){

     user = GoogleAuth.currentUser.get();
     isAuthorized = user.hasGrantedScopes(SCOPE);
    if (isAuthorized) {
        console.log(user.Ba);
  //GETS ID OF USER LOGGING IN
  let userId=String(user.Ba)

//GETS SENT MSGS details->  like message id,..
request = gapi.client.request({
  'method': 'GET',
  'path': `gmail/v1/users/${userId}/messages`,
  'params': {'labelIds': 'SENT'}
});
// Execute the API request.
request.execute(function(response) {
  sentmsgs=response.messages;
  //console.log(sentmsgs);
  //using MSG-ID to get some details to display for every message

  for(let i=0; i<sentmsgs.length;i++){
     // console.log(sentmsgs[i].id);
      let msgid=sentmsgs[i].id;
      request = gapi.client.request({
  'method': 'GET',
  'path': `gmail/v1/users/${userId}/messages/${msgid}`,
});
// Execute the API request.
request.execute(function(response) {
    //console.log(response)
    let to = response.payload.headers[5].value;
    let subject =response.payload.headers[3].value;
    let date = response.payload.headers[1].value.split(' ');
    let parts = response.payload.parts;
    let images=[];

    	//console.log(to,subject,date);
        //console.log(parts)
        for(let j=0;j<parts.length;j++){
            if(parts[j].mimeType=="image/jpeg"){
                images.push(parts[j].filename);
            }
        }
       // console.log(images);
       if(subject.trim().length==0){
            subject="(no subject)"
       }
       let data={'to':to,'subject':subject,'date':date,'images':images};
        let div = document.createElement("div");
        div.setAttribute("class","card");
        div.setAttribute("class","sent");
        content.appendChild(div);

        div.innerHTML=`
        <div class="fromaddress">to:${to}</div> 
         <div class="mailsubject">${subject}<span></div>  
          <div class="messagedate">${date[1]} ${date[2]} ${date[3]}</div> 
          
        `;
        if(images.length>0){
            if(images.length>1){
                div.innerHTML+=`<div><span class="attachment1">${images[0]} </span> <span class="attachment2">${images[1]}</span> <b> and ${images.length-2} more files</b><div> <br>`
            }else{
                div.innerHTML+=` <div><span class="attachment1">${images[0]}</span><div> <br>`
            }
        }
});
  }
});


//gmail/v1/users/{userId}/messages/{id} Eg msg id:17d1f14060a66ae9
//GETTING contents of specific message with message id from previous requests




//GETS INBOX MSGS details->  like message id,..
request = gapi.client.request({
  'method': 'GET',
  'path': `gmail/v1/users/${userId}/messages`,
  'params': {'labelIds': 'STARRED'}
});
// Execute the API request.
request.execute(function(response) {
    //console.log("INBOX msg");
    primarymsgs=response.messages;
  ///console.log(primarymsgs);
  for(let i=0;i<primarymsgs.length;i++){
      let msgid = primarymsgs[i].id;
        request = gapi.client.request({
    'method': 'GET',
    'path': `gmail/v1/users/${userId}/messages/${msgid}`,
    });
// Execute the API request.
request.execute(function(response) {
    
    let from
    let date
    let subject
    let snippet =response.snippet;
    let payload= response.payload.headers;
    
    for(let j=0;j<payload.length;j++){
        if(payload[j].name=='Date'){
            date = payload[j].value.split(' ');
        }else if(payload[j].name=='Subject'){
            subject=payload[j].value;
        }else if(payload[j].name=='From'){
            from=payload[j].value;
        }
    }
    //console.log(from,date,snippet);

        let div = document.createElement("div");
        div.setAttribute("class","card");
        div.setAttribute("class","starred");
        content.appendChild(div);

        if(snippet.length>3){
            div.innerHTML=`
        
        <div class="fromaddress">From:${from}</div> 
         <div class="mailsubject">${subject} - <span class="snippet">${snippet}<span></div>  
          <div class="messagedate">${date[1]} ${date[2]} ${date[3]}</div> 
          
          `;
        }else{
            div.innerHTML=`
        
        <div class="fromaddress">From:${from}</div> 
         <div class="mailsubject">${subject} <span></div>  
          <div class="messagedate">${date[1]} ${date[2]} ${date[3]}</div> 
          
          `;
        }

});

  }
});



 request = gapi.client.request({
  'method': 'GET',
  'path': `gmail/v1/users/${userId}/drafts`,
//   'params': {'fields': 'user'}
});
// Execute the API request.
request.execute(function(response) {
    response=response.drafts;
    //console.log(response);
    for(let i=0;i<response.length;i++){
       // console.log(response[i].id)
      
        let draftid = response[i].id;

        request = gapi.client.request({
    'method': 'GET',
    'path': `gmail/v1/users/${userId}/drafts/${draftid}`,
    });
// Execute the API request.
request.execute(function(response) {
    // console.log(response)
    let date;
    let to;
    let subject;
    let snippet = response.message.snippet;
    let payload= response.message.payload.headers;
    
    for(let j=0;j<payload.length;j++){
        if(payload[j].name=='Date'){
            date = payload[j].value.split(' ');
        }else if(payload[j].name=='Subject'){
            subject=payload[j].value;
        }else if(payload[j].name=='To'){
            to=payload[j].value;
        }
        
    }
    console.log(to,date,subject);
    if(subject.trim().length==0){
        subject="(no subject)";
    }
    if(to.trim().length==0){
        to="Draft"
    }else{
        to+=" Draft"
    }

});
    }
});

//https://gmail.googleapis.com/gmail/v1/users/{userId}/messages/{messageId}/attachments/{id}


    }
  
}



 </script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script async defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>

    <!-- <script src="https://apis.google.com/js/platform.js" async defer></script> -->
<script src="./script.js"></script>
</body>


</html>

